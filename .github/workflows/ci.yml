name: CI

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  test:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        python-version: [ '3.7', '3.8', '3.10', '3.12' ]
    steps:
      - uses: actions/checkout@v4

      - name: Configure git line endings
        run: git config --global core.safecrlf false

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: ${{ matrix.python-version }}

      - name: Cache pip
        uses: actions/cache@v4
        with:
          path: |
            ~/.cache/pip
            ~/.cache/pip/wheels
          key: ${{ runner.os }}-pip-${{ matrix.python-version }}-${{ hashFiles('**/requirements.txt') }}
          restore-keys: |
            ${{ runner.os }}-pip-

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          # 安装系统依赖，尝试多个备选包名并容错安装，避免在不同 Ubuntu 版本中因包名差异导致失败
          sudo apt-get update
          PACKAGES="libegl1-mesa libegl-mesa0 libegl1 libgl1-mesa-glx libgl1-mesa-dri libgl1 libxkbcommon0 libxrender1 libx11-6 libxcb1 xvfb mesa-utils"
          for pkg in $PACKAGES; do
            sudo apt-get install -y --no-install-recommends "$pkg" || true
          done
          # 如果仍缺少 libEGL，则尝试安装开发/替代包并刷新动态链接缓存
          if ! ldconfig -p | grep -q libEGL; then
            echo "libEGL 未找到，尝试安装额外候选包并刷新缓存"
            sudo apt-get install -y --no-install-recommends libegl1-dev libegl1-mesa-dev libgl1-mesa-dev || true
            sudo ldconfig || true
          fi
          # 最后再确认一次，若仍然没有则列出相关目录供调试
          if ! ldconfig -p | grep -q libEGL; then
            echo "最终仍未找到 libEGL，列出 /usr/lib 进行诊断："
            ls -la /usr/lib/x86_64-linux-gnu | head -n 80 || true
          fi
          pip install -r requirements.txt -i https://pypi.tuna.tsinghua.edu.cn/simple
          # 确保 coverage 支持插件可用
          pip install pytest-cov coverage -i https://pypi.tuna.tsinghua.edu.cn/simple

      - name: Run tests (headless)
        env:
          QT_QPA_PLATFORM: offscreen
        run: |
          # 使用 xvfb-run 在无头环境中运行 GUI 测试，同时收集覆盖率并生成报告
          xvfb-run -s "-screen 0 1920x1080x24" pytest -q --cov=src --cov-report=xml:coverage.xml --cov-report=html:coverage_html

      - name: Upload coverage artifact
        if: always()
        uses: actions/upload-artifact@v4
        with:
          # 给 artifact 名称添加 matrix 和 run 信息以避免不同作业/重复上传时产生同名冲突
          name: coverage-report-${{ matrix.python-version }}-run${{ github.run_number }}
          path: |
            coverage.xml
            coverage_html

  lint:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Configure git line endings
        run: git config --global core.safecrlf false

      - name: Set up Python for lint
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'

      - name: Install linting tools
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt -r requirements-dev.txt -i https://pypi.tuna.tsinghua.edu.cn/simple
          # 安装 pre-commit 以便在 CI 中运行 pre-commit 钩子
          pip install pre-commit -i https://pypi.tuna.tsinghua.edu.cn/simple

      - name: Run pre-commit hooks
        run: |
          # 先运行 pre-commit（会包含 black/isort/ruff/pylint）以统一开发者环境与 CI
          pre-commit run --all-files || true

      - name: Run black (check)
        run: |
          python -m black --version
          python -m black --check src/ tests/ gui/ gui_main.py batch.py || (echo 'Run `python -m black src/ tests/ gui/ gui_main.py batch.py` to format' && exit 1)

      - name: Run pylint (report + gate)
        run: |
          python -m pip show pylint || python -m pip install pylint -i https://pypi.tuna.tsinghua.edu.cn/simple
          # 输出完整结果用于日志/排查
          python -m pylint src/ --output-format=text > pylint_full.txt || true
          cat pylint_full.txt
          # 解析 score（示例输出行形如 "Your code has been rated at 9.98/10"）
          SCORE=$(grep 'Your code has been rated at' pylint_full.txt | tail -n1 | awk -F'/' '{print $1}' | awk '{print $NF}')
          echo "Pylint score: $SCORE"
          # 用 awk 做数值比较（避免 heredoc/缩进问题）
          echo "$SCORE" | awk '{ if ($1+0 < 7.0) { print "Pylint score below 7.0, failing CI"; exit 1 } }'
