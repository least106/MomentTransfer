name: Tests

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  test:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        python-version: [ '3.8', '3.10', '3.12' ]
    steps:
      - uses: actions/checkout@v4

      - name: Configure git line endings
        run: git config --global core.safecrlf false

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: ${{ matrix.python-version }}

      - name: Cache pip
        uses: actions/cache@v4
        with:
          path: |
            ~/.cache/pip
            ~/.cache/pip/wheels
          key: ${{ runner.os }}-pip-${{ matrix.python-version }}-${{ hashFiles('**/requirements.txt') }}
          restore-keys: |
            ${{ runner.os }}-pip-

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          # 安装系统依赖，尝试多个备选包名并容错安装，避免在不同 Ubuntu 版本中因包名差异导致失败
          sudo apt-get update
          PACKAGES="libegl1-mesa libegl-mesa0 libegl1 libgl1-mesa-glx libgl1-mesa-dri libgl1 libxkbcommon0 libxrender1 libx11-6 libxcb1 xvfb mesa-utils"
          for pkg in $PACKAGES; do
            sudo apt-get install -y --no-install-recommends "$pkg" || true
          done
          # 如果仍缺少 libEGL，则尝试安装开发/替代包并刷新动态链接缓存
          if ! ldconfig -p | grep -q libEGL; then
            echo "libEGL 未找到，尝试安装额外候选包并刷新缓存"
            sudo apt-get install -y --no-install-recommends libegl1-dev libegl1-mesa-dev libgl1-mesa-dev || true
            sudo ldconfig || true
          fi
          # 最后再确认一次，若仍然没有则列出相关目录供调试
          if ! ldconfig -p | grep -q libEGL; then
            echo "最终仍未找到 libEGL，列出 /usr/lib 进行诊断："
            ls -la /usr/lib/x86_64-linux-gnu | head -n 80 || true
          fi
          # 首选使用清华镜像；若遇到 403 等错误，则回退到官方 PyPI
          pip install -r requirements.txt -i https://pypi.tuna.tsinghua.edu.cn/simple || python -m pip install -r requirements.txt --index-url https://pypi.org/simple --no-cache-dir
          # 确保 coverage 支持插件可用，亦加入回退机制
          pip install pytest-cov coverage -i https://pypi.tuna.tsinghua.edu.cn/simple || python -m pip install pytest-cov coverage --index-url https://pypi.org/simple --no-cache-dir

      - name: Run tests (headless)
        env:
          QT_QPA_PLATFORM: offscreen
        run: |
          # 使用 xvfb-run 在无头环境中运行 GUI 测试，同时收集覆盖率并生成报告
          xvfb-run -s "-screen 0 1920x1080x24" pytest -q --cov=src --cov-report=xml:coverage.xml --cov-report=html:coverage_html

      - name: Upload coverage artifact
        if: always()
        uses: actions/upload-artifact@v4
        with:
          # 给 artifact 名称添加 matrix 和 run 信息以避免不同作业/重复上传时产生同名冲突
          name: coverage-report-${{ matrix.python-version }}-run${{ github.run_number }}
          path: |
            coverage.xml
            coverage_html
