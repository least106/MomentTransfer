# 配置修改检测 - 用户使用指南

## 快速开始

### 场景 1: 正常工作流程（修改配置后保存）

```
1. 加载配置文件
   → 点击"加载配置"按钮
   → 选择 .json 配置文件

2. 编辑坐标系参数
   → 在"参考系管理"选项卡中修改 Source/Target 参数
   → 系统自动追踪修改（无需手动操作）

3. 保存配置
   → 右键点击配置面板 或 菜单 > 文件 > 保存配置
   → 系统确认保存完成

4. 启动批处理
   → 点击"开始处理"按钮
   → 批处理立即启动（因为配置已保存）
```

### 场景 2: 编辑后直接启动批处理（需要确认）

```
1. 加载配置文件
2. 编辑坐标系参数
   → 修改 Source 或 Target 的坐标系、参考值等

3. 点击"开始处理"
   → 弹出对话框："配置已修改"
   
4. 选择操作
   ✓ 保存(Save): 保存修改的配置后返回
   ✓ 不保存(Discard): 使用内存中的修改配置启动批处理
   ✓ 取消(Cancel): 返回编辑，不启动批处理
```

## 对话框说明

### "配置已修改" 对话框

当您在编辑配置后点击"开始处理"时，系统会弹出这个对话框：

```
┌─────────────────────────────────────────┐
│         配置已修改                       │
├─────────────────────────────────────────┤
│ 检测到配置已修改但未保存。              │
│                                         │
│ 是否要保存修改的配置后再进行批处理？   │
├─────────────────────────────────────────┤
│  [保存]  [不保存]  [取消]               │
└─────────────────────────────────────────┘
```

#### 按钮说明

| 按钮 | 行为 | 何时使用 |
|------|------|---------|
| **保存** | 保存修改的配置到文件，然后返回编辑页面 | 您想要保存这些修改 |
| **不保存** | 使用内存中的修改配置启动批处理（不保存文件） | 您只想临时使用这些修改 |
| **取消** | 取消批处理操作，返回编辑页面 | 您想继续编辑或放弃修改 |

## 修改追踪机制

### 什么时候被认为"已修改"

✅ **以下操作会标记配置为"已修改"**:
- 修改 Source 坐标系参数（原点、轴向、参考值等）
- 修改 Target 坐标系参数
- 修改 Moment Center（动压中心）
- 修改参考长度 (Cref)、参考面积 (Sref)、参考翼展 (Bref)
- 修改动压 (Q) 值
- 选择不同的 Part

❌ **以下操作不会标记为修改**:
- 加载配置文件
- 只浏览文件（未点保存）
- 切换 Tab 或最小化窗口

### 何时修改标志被重置

修改标志会在以下情况自动重置为"未修改":
1. ✅ 成功保存配置
2. ✅ 加载新的配置文件
3. ✅ 创建新项目

## 常见问题

### Q1: 我修改了配置但点了"不保存"启动批处理，配置会丢失吗？

**A**: 不会。您的修改仍然在内存中，可以在批处理完成后继续编辑和保存。只有当您：
- 加载新的配置文件，或
- 关闭应用程序

配置才会丢失。

### Q2: "保存"和"不保存"有什么区别？

**A**: 
- **保存**: 将修改写入磁盘 .json 文件，后续操作基于保存的配置
- **不保存**: 使用内存中的修改配置，不写入文件，下次加载仍是原配置

### Q3: 为什么我看不到修改提示？

**A**: 可能的原因：
1. 您只编辑了 Part 名称，没有修改坐标系参数
2. 您修改的参数实际上没有变化（值相同）
3. 系统配置管理器未初始化

### Q4: 我不小心点了"不保存"，现在想保存修改怎么办？

**A**: 请在批处理完成后立即：
1. 不要加载新的配置文件
2. 不要创建新项目
3. 立即点击"保存配置"
4. 等待保存完成

### Q5: 修改标志在哪里显示？

**A**: 当前版本中，修改标志仅在您尝试启动批处理时显示。未来版本可能在：
- 标题栏显示 `*` 符号
- 配置面板标题显示 "已修改"
- 状态栏显示修改指示器

## 最佳实践

### 建议的工作流程

```
┌─────────────────────────────────────┐
│ 1. 加载配置 (Load Config)           │
└──────────────┬──────────────────────┘
               │
               ↓
┌─────────────────────────────────────┐
│ 2. 编辑坐标系 (Edit Parameters)     │
│    (系统自动追踪修改)               │
└──────────────┬──────────────────────┘
               │
               ↓
┌─────────────────────────────────────┐
│ 3. 保存配置 (Save Config)           │
│    (点保存，确认保存完成)           │
└──────────────┬──────────────────────┘
               │
               ↓
┌─────────────────────────────────────┐
│ 4. 启动批处理 (Start Processing)    │
│    (无对话框，直接启动)             │
└─────────────────────────────────────┘
```

### 避免的操作

❌ **不要**:
1. 编辑配置后直接关闭应用（未保存）
2. 编辑后加载新配置而不保存
3. 修改配置但不知道是否已保存
4. 在不确定是否保存的情况下启动批处理

✅ **要**:
1. 修改配置后立即保存
2. 确认对话框显示后再做决定
3. 在状态栏查看保存确认信息
4. 保存后再进行其他操作

## 技术细节

### 配置修改检测的工作原理

```
配置管理器 (ConfigManager)
    │
    ├─ _config_modified (布尔标志)
    │
    ├─ is_config_modified() 
    │  └─ 返回修改状态
    │
    └─ set_config_modified(bool)
       └─ 设置修改状态

坐标系面板 (CoordinateSystemPanel)
    │
    └─ valuesChanged 信号
       └─ 用户编辑时发射
          └─ ConfigManager.set_config_modified(True)

批处理管理器 (MainWindow)
    │
    └─ run_batch_processing()
       └─ 检查 is_config_modified()
          └─ 若为 True，弹出对话框
```

## 支持和反馈

如遇到问题或有建议，请：
1. 查看详细文档: [IMPLEMENTATION_CONFIG_MODIFICATION_DETECTION.md](IMPLEMENTATION_CONFIG_MODIFICATION_DETECTION.md)
2. 查看完成报告: [COMPLETION_REPORT.md](COMPLETION_REPORT.md)
3. 查看源代码注释: [gui/config_manager.py](gui/config_manager.py)

---

**版本**: 1.0  
**更新日期**: 2026-01-26  
**兼容性**: Python 3.8+, PySide6
